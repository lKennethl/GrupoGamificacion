<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Tienda de Personajes - Compra tu Compañero Ideal</title>
<script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
<style>
  :root {
    --primary-color: #ff6b6b;
    --secondary-color: #4ecdc4;
    --accent-color: #45b7d1;
    --success-color: #00b894;
    --warning-color: #fdcb6e;
    --error-color: #e17055;
    --purple-color: #a29bfe;
    --orange-color: #fd79a8;
    --coin-color: #f39c12;
    --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --card-gradient: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(240, 248, 255, 0.95));
    --text-light: #ffffff;
    --text-dark: #2d3436;
    --shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
  }
  * {
    margin: 0; padding: 0; box-sizing: border-box;
  }
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
  }
  body {
    font-family: 'Comic Sans MS', cursive, sans-serif;
    background: var(--background-gradient);
    min-height: 100vh;
    overflow-y: auto;
    overflow-x: hidden;
    position: relative;
    scroll-behavior: smooth;
    cursor: grab;
    font-size: 16px;
    color: var(--text-dark);
  }
  body.dragging {
    cursor: grabbing;
    user-select: none;
  }
  @media (min-width: 769px) {
    ::-webkit-scrollbar {
      width: 18px;
    }
    ::-webkit-scrollbar-track {
      background: linear-gradient(180deg, rgba(255, 107, 107, 0.3), rgba(78, 205, 196, 0.3));
      border-radius: 15px;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #ff6b6b, #4ecdc4, #45b7d1, #a29bfe);
      border-radius: 15px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
    }
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #e55656, #3bb8b0, #3a9bc1, #8b7ed8);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
    }
  }
  .scroll-indicator {
    position: fixed;
    top: 0; left: 0;
    width: 0%;
    height: 6px;
    background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #a29bfe, #fd79a8);
    z-index: 1000;
    transition: width 0.3s ease;
    box-shadow: 0 3px 15px rgba(0, 0, 0, 0.4);
  }
  .floating-decoration {
    position: fixed;
    font-size: 2.5rem;
    opacity: 0.7;
    animation: float 6s ease-in-out infinite;
    pointer-events: none;
    z-index: 1;
  }
  .decoration-1 { top: 10%; left: 10%; animation-delay: 0s; }
  .decoration-2 { top: 20%; right: 15%; animation-delay: 1s; }
  .decoration-3 { bottom: 20%; left: 20%; animation-delay: 2s; }
  .decoration-4 { top: 60%; right: 10%; animation-delay: 3s; }
  .decoration-5 { bottom: 10%; right: 25%; animation-delay: 4s; }
  .decoration-6 { top: 40%; left: 5%; animation-delay: 5s; }
  @keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.7; }
    50% { transform: translateY(-25px) rotate(15deg); opacity: 1; }
  }
  .header {
    position: fixed;
    top: 0; left: 0; right: 0;
    background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(45, 52, 54, 0.9));
    backdrop-filter: blur(15px);
    padding: 1rem 2rem;
    z-index: 100;
    border-bottom: 3px solid rgba(78, 205, 196, 0.3);
    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
  }
  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 1200px;
    margin: 0 auto;
  }
  .header-title {
    color: var(--text-light);
    font-size: 2.2rem;
    font-weight: bold;
    text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
    background: linear-gradient(45deg, #fff, var(--secondary-color));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .header-stats {
    display: flex;
    align-items: center;
    gap: 20px;
  }
  .coin-display {
    background: linear-gradient(45deg, var(--coin-color), #e67e22);
    color: white;
    padding: 12px 24px 12px 12px;
    border-radius: 25px;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 14px;
    font-size: 1.2rem;
    animation: coinGlow 2s infinite;
    border: 3px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
  }
  .coin-display span:first-child {
    font-size: 1.6rem;
  }
  .back-button {
    background: linear-gradient(45deg, var(--primary-color), var(--orange-color));
    color: white;
    padding: 12px 25px;
    font-size: 1rem;
    font-weight: bold;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.2);
  }
  .back-button:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 10px 25px rgba(255, 107, 107, 0.6);
  }
  .main-content {
    margin-top: 100px;
    padding: 2rem;
    min-height: calc(100vh - 100px);
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
  }
  .main-title {
    text-align: center;
    color: var(--text-light);
    font-size: 3rem;
    font-weight: bold;
    text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.8);
    margin-bottom: 1rem;
    background: linear-gradient(45deg, #fff, var(--secondary-color), var(--accent-color));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: titleGlow 3s infinite;
  }
  .main-subtitle {
    text-align: center;
    color: var(--text-light);
    font-size: 1.4rem;
    opacity: 0.9;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    margin-bottom: 3rem;
  }
  .character-filters {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 3rem;
    flex-wrap: wrap;
  }
  .filter-btn {
    background: linear-gradient(45deg, var(--secondary-color), var(--accent-color));
    color: white;
    padding: 10px 20px;
    font-size: 1rem;
    font-weight: bold;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid rgba(255, 255, 255, 0.3);
  }
  .filter-btn:hover, .filter-btn.active {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 8px 20px rgba(78, 205, 196, 0.6);
  }
  .filter-btn.active {
    background: linear-gradient(45deg, var(--success-color), #55efc4);
  }
  .characters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 30px;
    margin-bottom: 3rem;
  }
  .character-card {
    background: var(--card-gradient);
    border-radius: 25px;
    padding: 1.5rem 1.5rem 2rem 1.5rem;
    box-shadow: var(--shadow);
    border: 3px solid rgba(78, 205, 196, 0.4);
    backdrop-filter: blur(15px);
    position: relative;
    overflow: hidden;
    animation: fadeInUp 1s ease-out both;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .character-card:hover {
    transform: translateY(-15px) scale(1.05);
    box-shadow: 0 30px 70px rgba(0, 0, 0, 0.5);
  }
  .character-card.owned {
    border-color: var(--success-color);
    background: linear-gradient(135deg, rgba(0, 184, 148, 0.1), rgba(255, 255, 255, 0.95));
  }
  .character-card.owned::after {
    content: '✅ COMPRADO';
    position: absolute;
    top: 15px;
    right: 15px;
    background: var(--success-color);
    color: white;
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: bold;
    z-index: 10;
  }
  .character-model {
    width: 100%;
    height: 280px;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    background: radial-gradient(circle, rgba(78, 205, 196, 0.2), rgba(69, 183, 209, 0.2));
    position: relative;
  }
  .character-model model-viewer {
    width: 100%;
    height: 100%;
    border-radius: 20px;
  }
  .expand-btn {
    position: absolute;
    bottom: 10px;
    right: 10px;
    background: var(--accent-color);
    border-radius: 50%;
    width: 36px;
    height: 36px;
    border: none;
    color: white;
    font-size: 24px;
    line-height: 36px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    transition: background 0.3s ease;
    z-index: 20;
  }
  .expand-btn:hover {
    background: var(--secondary-color);
  }
  .character-info {
    text-align: center;
    margin-top: 1rem;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .character-name {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
    text-transform: capitalize;
  }
  .character-description {
    font-size: 1rem;
    color: #636e72;
    margin-bottom: 1rem;
    line-height: 1.4;
    flex-grow: 1;
  }
  .character-rarity {
    display: inline-block;
    padding: 5px 15px;
    border-radius: 15px;
    font-size: 0.9rem;
    font-weight: bold;
    margin-bottom: 1rem;
  }
  .rarity-common {
    background: linear-gradient(45deg, #74b9ff, #0984e3);
    color: white;
  }
  .rarity-rare {
    background: linear-gradient(45deg, #a29bfe, #6c5ce7);
    color: white;
  }
  .rarity-epic {
    background: linear-gradient(45deg, #fd79a8, #e84393);
    color: white;
  }
  .rarity-legendary {
    background: linear-gradient(45deg, #fdcb6e, #e17055);
    color: white;
    animation: legendaryGlow 2s infinite;
  }
  @keyframes legendaryGlow {
    0%, 100% { box-shadow: 0 0 10px rgba(253, 203, 110, 0.5); }
    50% { box-shadow: 0 0 20px rgba(253, 203, 110, 0.8); }
  }
  .character-price {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 2px solid rgba(78, 205, 196, 0.3);
  }
  .price-display {
    display: flex;
    align-items: center;
    gap: 14px; /* Increased gap for better spacing */
    font-size: 1.3rem;
    font-weight: bold;
    color: var(--coin-color);
  }
  .buy-button {
    background: linear-gradient(45deg, var(--success-color), #55efc4);
    color: white;
    padding: 10px 20px;
    font-size: 1rem;
    font-weight: bold;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid rgba(255, 255, 255, 0.3);
  }
  .buy-button:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 8px 20px rgba(0, 184, 148, 0.6);
  }
  .buy-button:disabled {
    background: linear-gradient(45deg, #636e72, #2d3436);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
  .buy-button.owned {
    background: linear-gradient(45deg, var(--accent-color), #74b9ff);
  }
  .new-characters-card {
    background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
    border-radius: 25px;
    padding: 2rem;
    box-shadow: 0 15px 40px rgba(255, 105, 135, 0.5);
    border: 3px solid rgba(255, 105, 135, 0.7);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    font-weight: bold;
    font-size: 1.5rem;
    color: #fff;
    cursor: default;
    user-select: none;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .new-characters-card:hover {
    transform: scale(1.05);
    box-shadow: 0 25px 60px rgba(255, 105, 135, 0.8);
  }
  .new-characters-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
  }
  /* Modal styles */
  .purchase-modal {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background:rgba(0,0,0,0.8);
    display: flex; justify-content: center; align-items: center;
    z-index: 400;
    opacity: 0; visibility: hidden;
    transition: all 0.4s ease;
  }
  .purchase-modal.show {
    opacity: 1; visibility: visible;
  }
  .modal-content {
    background: var(--card-gradient);
    border-radius: 25px;
    padding: 3rem;
    max-width: 600px;
    width: 90%;
    box-shadow: 0 30px 70px rgba(0,0,0,0.4);
    border: 3px solid rgba(78,205,196,0.4);
    animation: modalSlideIn 0.8s cubic-bezier(0.175,0.885,0.32,1.275);
    text-align: center;
    position: relative;
  }
  .modal-character {
    width: 300px;
    height: 300px;
    margin: 0 auto 1.5rem;
    border-radius: 25px;
    overflow: hidden;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
  }
  .modal-character model-viewer {
    width: 100%;
    height: 100%;
    border-radius: 25px;
  }
  .modal-title {
    font-size: 2rem;
    color: var(--text-dark);
    font-weight: bold;
    margin-bottom: 1rem;
  }
  .modal-message {
    font-size: 1.2rem;
    color: #636e72;
    margin-bottom: 2rem;
    line-height: 1.5;
  }
  .modal-price {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--coin-color);
    margin-bottom: 2rem;
    padding: 15px;
    background: rgba(243, 156, 18, 0.1);
    border-radius: 15px;
    border: 2px solid rgba(243, 156, 18, 0.3);
  }
  .modal-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
  }
  .modal-btn {
    padding: 12px 25px;
    font-size: 1.1rem;
    font-weight: bold;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid rgba(255, 255, 255, 0.3);
    min-width: 140px;
  }
  .modal-btn.confirm {
    background: linear-gradient(45deg, var(--success-color), #55efc4);
    color: white;
  }
  .modal-btn.cancel {
    background: linear-gradient(45deg, var(--error-color), #d63031);
    color: white;
  }
  .modal-btn:hover {
    transform: translateY(-2px) scale(1.05);
  }
  .success-modal {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex; justify-content: center; align-items: center;
    z-index: 500;
    opacity: 0; visibility: hidden;
    transition: all 0.4s ease;
  }
  .success-modal.show {
    opacity: 1; visibility: visible;
  }
  .success-content {
    background: linear-gradient(135deg, rgba(0, 184, 148, 0.95), rgba(85, 239, 196, 0.95));
    border-radius: 25px;
    padding: 3rem;
    text-align: center;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 30px 70px rgba(0, 0, 0, 0.4);
    border: 3px solid rgba(255, 255, 255, 0.4);
    animation: successSlideIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    color: white;
  }
  .success-icon {
    font-size: 5rem;
    margin-bottom: 1rem;
    animation: successBounce 1s infinite;
  }
  .success-title {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 1rem;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
  }
  .success-message {
    font-size: 1.3rem;
    margin-bottom: 2rem;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
  }
  .success-buttons {
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
  }
  .success-btn {
    background: rgba(255, 255, 255, 0.9);
    color: var(--text-dark);
    padding: 12px 25px;
    font-size: 1.1rem;
    font-weight: bold;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 140px;
  }
  .success-btn:hover {
    background: white;
    transform: translateY(-2px) scale(1.05);
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(50px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes cardShine {
    0% { transform: rotate(45deg) translate(-200%, -200%); }
    50% { transform: rotate(45deg) translate(-50%, -50%); }
    100% { transform: rotate(45deg) translate(200%, 200%); }
  }
  @keyframes titleGlow {
    0%, 100% { filter: brightness(1); }
    50% { filter: brightness(1.2); }
  }
  @keyframes coinGlow {
    0%, 100% { box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); }
    50% { box-shadow: 0 12px 30px rgba(243, 156, 18, 0.6); }
  }
  @keyframes modalSlideIn {
    from { opacity: 0; transform: translateY(-50px) scale(0.8); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
  @keyframes successSlideIn {
    from { opacity: 0; transform: translateY(-100px) scale(0.5); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
  @keyframes successBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }
</style>

</head>
<body>

  <!-- Scroll indicator -->
  <div class="scroll-indicator" id="scrollIndicator"></div>
  <!-- Floating decorations -->
  <div class="floating-decoration decoration-1">🛒</div>
  <div class="floating-decoration decoration-2">👾</div>
  <div class="floating-decoration decoration-3">💎</div>
  <div class="floating-decoration decoration-4">🎭</div>
  <div class="floating-decoration decoration-5">🌟</div>
  <div class="floating-decoration decoration-6">🎪</div>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <h1 class="header-title">🛒 Tienda de Personajes</h1>
      <div class="header-stats">
        <div class="coin-display" aria-label="Monedas disponibles">
          <span>🪙</span>
          <span id="playerCoins">0</span>
          <span>Monedas</span>
        </div>
        <button class="back-button" onclick="goBack()" aria-label="Volver al menú principal">🔙 Volver al Menú</button>
      </div>
    </div>
  </div>
  <!-- Main content -->
  <div class="main-content">
    <h1 class="main-title">🎭 Elige tu Compañero Perfecto</h1>
    <p class="main-subtitle">¡Descubre increíbles personajes 3D para acompañarte en tu aventura de aprendizaje!</p>
    <!-- Filters -->
    <div class="character-filters" role="group" aria-label="Filtros de personajes">
      <button class="filter-btn active" onclick="filterCharacters('all')" aria-pressed="true">🌟 Todos</button>
      <button class="filter-btn" onclick="filterCharacters('common')" aria-pressed="false">🔵 Común</button>
      <button class="filter-btn" onclick="filterCharacters('rare')" aria-pressed="false">🟣 Raro</button>
      <button class="filter-btn" onclick="filterCharacters('epic')" aria-pressed="false">🟡 Épico</button>
      <button class="filter-btn" onclick="filterCharacters('legendary')" aria-pressed="false">🔥 Legendario</button>
      <button class="filter-btn" onclick="filterCharacters('owned')" aria-pressed="false">✅ Comprados</button>
    </div>
    <!-- Characters grid -->
    <div class="characters-grid" id="charactersGrid" role="list"></div>
  </div>

  <!-- Purchase modal -->
  <div class="purchase-modal" id="purchaseModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalMessage">
    <div class="modal-content">
      <div class="modal-character" id="modalCharacter">
        <model-viewer 
          id="modalCharacterModel"
          src=""
          alt="Personaje 3D"
          camera-controls
          auto-rotate
          rotation-per-second="20deg"
          shadow-intensity="1"
          environment-image="neutral"
          exposure="1"
          loading="eager"
          autoplay
        ></model-viewer>
      </div>
      <h2 class="modal-title" id="modalTitle">¿Comprar Personaje?</h2>
      <p class="modal-message" id="modalMessage">¿Estás seguro de que quieres comprar este increíble personaje?</p>
      <div class="modal-price" id="modalPrice">🪙 50 Monedas</div>
      <div class="modal-buttons">
        <button class="modal-btn confirm" onclick="confirmPurchase()" aria-label="Confirmar compra">✅ Comprar</button>
        <button class="modal-btn cancel" onclick="closePurchaseModal()" aria-label="Cancelar compra">❌ Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Success modal -->
  <div class="success-modal" id="successModal" role="alertdialog" aria-modal="true" aria-labelledby="successTitle" aria-describedby="successMessage">
    <div class="success-content">
      <div class="success-icon" aria-hidden="true">🎉</div>
      <h2 class="success-title" id="successTitle">¡Compra Exitosa!</h2>
      <p class="success-message" id="successMessage">Tu nuevo personaje ha sido añadido a "Mis Personajes"</p>
      <div class="success-buttons">
        <button class="success-btn" onclick="goToMyCharacters()" aria-label="Ver mis personajes">👥 Ver Mis Personajes</button>
        <button class="success-btn" onclick="closeSuccessModal()" aria-label="Seguir comprando">🛒 Seguir Comprando</button>
      </div>
    </div>
  </div>

<script>
  let playerCoins = 0;
  let ownedCharacters = [];
  let currentFilter = 'all';
  let selectedCharacter = null;
  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

  // Characters database with only requested characters and corrected relative paths
  const charactersDatabase = [
    { id: 'balerina_capuchina', name: 'Balerina Capuchina', description: 'Una bailarina elegante y encantadora para acompañarte.', model: 'images/3D/balerina_capuchina/scene.gltf', price: 50, rarity: 'rare' },
    { id: 'bombardino_crocodilo', name: 'Bombardino Crocodilo', description: 'Un cocodrilo musical con ritmo y estilo.', model: 'images/3D/bombardino_crocodilo/scene.gltf', price: 60, rarity: 'rare' },
    { id: 'capuchino_assasino', name: 'Capuchino Asasino', description: 'Un ninja sigiloso con habilidades de café. ¡Despierta tu mente!', model: 'images/3D/capuchino_assasino/scene.gltf', price: 85, rarity: 'epic' },
    { id: 'la_vaca_saturno_saturnito', name: 'La Vaca Saturno Saturnito', description: 'Una vaca espacial que te llevará a nuevas galaxias.', model: 'images/3D/la_vaca_saturno_saturnito/scene.gltf', price: 70, rarity: 'epic' },
    { id: 'tralalero_tralala', name: 'Tralalero Tralala', description: 'Un personaje alegre y musical para animar tus días.', model: 'images/3D/tralalero_tralala/scene.gltf', price: 40, rarity: 'common' },
    { id: 'tung_tung_sahur', name: 'Tung Tung Sahur', description: 'Un guerrero místico para tus aventuras.', model: 'images/3D/tung_tung_sahur/scene.gltf', price: 65, rarity: 'epic' },
    { id: 'tung_tung_sahur_phase_2', name: 'Tung Tung Sahur Phase 2', description: 'Un guerrero místico en su segunda fase de evolución. Perfecto para aventuras épicas.', model: 'images/3D/tung_tung_sahur_phase_2/scene.gltf', price: 75, rarity: 'epic' },
    { id: 'tung_tung_sahur_titan', name: 'Tung Tung Sahur Titan', description: 'La forma más poderosa del legendario Tung Tung. ¡Imparable en batalla!', model: 'images/3D/tung_tung_sahur_titan/scene.gltf', price: 150, rarity: 'legendary' },
    { id: 'brr_brr_patapim_breakdance', name: 'Brr Brr Patapim Breakdance', description: 'La versión bailarina de Patapim. ¡Con movimientos increíbles!', model: 'images/3D/brr_brr_patapim_breakdance/scene.gltf', price: 60, rarity: 'rare' },
    { id: 'brr_brr_patapim_dancing', name: 'Brr Brr Patapim Dancing', description: 'Patapim en modo fiesta. Perfecto para celebrar tus logros.', model: 'images/3D/brr_brr_patapim_dancing/scene.gltf', price: 55, rarity: 'rare' },
    { id: 'capucchino_assesino', name: 'Capucchino Assesino', description: 'Un ninja sigiloso con habilidades de café. ¡Despierta tu mente!', model: 'images/3D/capucchino_assesino/scene.gltf', price: 85, rarity: 'epic' },
    { id: 'chimpanzini_bananini', name: 'Chimpanzini Bananini', description: 'Un mono inteligente que ama las bananas y los libros.', model: 'images/3D/chimpanzini_bananini/scene.gltf', price: 40, rarity: 'common' },
    { id: 'avocado_gorilla', name: 'Avocado Gorilla', description: 'Un gorila aguacate que te ayudará a mantener la calma.', model: 'images/3D/avocado_gorilla/scene.gltf', price: 45, rarity: 'rare' },
    { id: 'shpioniro_golubiro', name: 'Shpioniro Golubiro', description: 'Un espía astuto y veloz.', model: 'images/3D/shpioniro_golubiro/scene.gltf', price: 65, rarity: 'epic' },
    { id: 'skebob_v2', name: 'Skebob V2', description: 'La versión mejorada del clásico Skebob. ¡Más divertido que nunca!', model: 'images/3D/skebob_v2/scene.gltf', price: 70, rarity: 'epic' },
    { id: 'tung_tung_sahur_destructor_astro_toilet', name: 'Tung Tung Destructor Astro Toilet', description: 'La forma más extraña y poderosa de Tung Tung. ¡Único en su especie!', model: 'images/3D/tung_tung_sahur_destructor_astro_toilet/scene.gltf', price: 180, rarity: 'legendary' }
  ];

  // Load player coins from localStorage or default 100
  function loadPlayerCoins() {
    const coins = localStorage.getItem('totalCoins') || '100';
    playerCoins = parseInt(coins, 10);
    document.getElementById('playerCoins').textContent = playerCoins;
  }

  // Load owned characters from localStorage
  function loadOwnedCharacters() {
    const owned = localStorage.getItem('ownedCharacters');
    ownedCharacters = owned ? JSON.parse(owned) : [];
  }

  // Update coins display and storage
  function updateCoins(amount) {
    playerCoins += amount;
    localStorage.setItem('totalCoins', playerCoins.toString());
    document.getElementById('playerCoins').textContent = playerCoins;
  }

  // Render characters
    function renderCharacters() {
    const grid = document.getElementById('charactersGrid');
    grid.innerHTML = '';

    // New characters card (re-added)
    const newCharCard = document.createElement('div');
    newCharCard.className = 'new-characters-card';
    newCharCard.setAttribute('role', 'listitem');
    newCharCard.setAttribute('tabindex', '0');
    newCharCard.innerHTML = `
      <div class="new-characters-icon" aria-hidden="true">✨</div>
      ¡Próximamente nuevos personajes increíbles!
      <br><small>¡Mantente atento para más sorpresas!</small>
    `;
    grid.appendChild(newCharCard);

    let filteredCharacters = charactersDatabase;
    if (currentFilter !== 'all') {
      if (currentFilter === 'owned') {
        filteredCharacters = charactersDatabase.filter(char =>
          ownedCharacters.some(owned => owned.id === char.id)
        );
      } else {
        filteredCharacters = charactersDatabase.filter(char => char.rarity === currentFilter);
      }
    }

    if (filteredCharacters.length === 0) {
      const noResult = document.createElement('div');
      noResult.style.gridColumn = '1 / -1';
      noResult.style.textAlign = 'center';
      noResult.style.padding = '3rem';
      noResult.style.color = 'white';
      noResult.style.fontSize = '1.5rem';
      noResult.setAttribute('role', 'listitem');
      noResult.innerHTML = `
        <div style="font-size: 4rem; margin-bottom: 1rem;">😔</div>
        No se encontraron personajes con este filtro
      `;
      grid.appendChild(noResult);
      return;
    }

    filteredCharacters.forEach((character, index) => {
      const isOwned = ownedCharacters.some(owned => owned.id === character.id);
      const canAfford = playerCoins >= character.price;

      const characterCard = document.createElement('div');
      characterCard.className = `character-card ${isOwned ? 'owned' : ''}`;
      characterCard.style.animationDelay = `${index * 0.1}s`;
      characterCard.setAttribute('role', 'listitem');
      characterCard.setAttribute('tabindex', '0');

      characterCard.innerHTML = `
        <div class="character-model" tabindex="0" aria-label="Modelo 3D de ${character.name}">
          <model-viewer 
            src="${character.model}"
            alt="${character.name}"
            camera-controls
            auto-rotate
            rotation-per-second="${isMobile ? '10deg' : '15deg'}"
            shadow-intensity="1"
            environment-image="neutral"
            exposure="1"
            loading="eager"
            interaction-prompt="${isMobile ? 'none' : 'auto'}"
            autoplay
          ></model-viewer>
          <button class="expand-btn" aria-label="Ampliar modelo 3D de ${character.name}" onclick="open3DViewer('${character.model}', '${character.name}')">+</button>
        </div>
        <div class="character-info">
          <h3 class="character-name">${character.name}</h3>
          <p class="character-description">${character.description}</p>
          <span class="character-rarity rarity-${character.rarity}">
            ${getRarityText(character.rarity)}
          </span>
          <div class="character-price">
            <div class="price-display" aria-label="Precio: ${character.price} monedas">
              <span>🪙</span>
              <span>${character.price}</span>
            </div>
            <button 
              class="buy-button ${isOwned ? 'owned' : ''}" 
              ${isOwned ? 'disabled' : ''}
              ${!canAfford && !isOwned ? 'disabled' : ''}
              onclick="${isOwned ? `selectCharacter('${character.id}')` : `openPurchaseModal('${character.id}')`}"
              aria-label="${isOwned ? 'Seleccionar personaje ' + character.name : (canAfford ? 'Comprar personaje ' + character.name : 'No tienes monedas suficientes para comprar ' + character.name)}"
            >
              ${isOwned ? '✅ Seleccionar' : (canAfford ? '🛒 Comprar' : '💰 Sin fondos')}
            </button>
          </div>
        </div>
      `;

      grid.appendChild(characterCard);
    });
  }

  function getRarityText(rarity) {
    const rarityTexts = {
      common: '🔵 Común',
      rare: '🟣 Raro',
      epic: '🟡 Épico',
      legendary: '🔥 Legendario'
    };
    return rarityTexts[rarity] || rarity;
  }

  function filterCharacters(filter) {
    currentFilter = filter;
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.classList.remove('active');
      btn.setAttribute('aria-pressed', 'false');
    });
    event.target.classList.add('active');
    event.target.setAttribute('aria-pressed', 'true');
    renderCharacters();
  }

  function openPurchaseModal(characterId) {
    const character = charactersDatabase.find(char => char.id === characterId);
    if (!character) return;
    selectedCharacter = character;
    const modalModel = document.getElementById('modalCharacterModel');
    modalModel.src = character.model;
    modalModel.setAttribute('rotation-per-second', isMobile ? '10deg' : '20deg');
    modalModel.setAttribute('interaction-prompt', isMobile ? 'none' : 'auto');
    document.getElementById('modalTitle').textContent = `¿Comprar ${character.name}?`;
    document.getElementById('modalMessage').textContent = character.description;
    document.getElementById('modalPrice').innerHTML = `🪙 ${character.price} Monedas`;
    document.getElementById('purchaseModal').classList.add('show');
  }

  function closePurchaseModal() {
    document.getElementById('purchaseModal').classList.remove('show');
    selectedCharacter = null;
  }

  function confirmPurchase() {
    if (!selectedCharacter) return;
    if (playerCoins < selectedCharacter.price) {
      alert('💰 No tienes suficientes monedas para comprar este personaje.\n\n¡Sigue jugando para ganar más monedas!');
      return;
    }
    updateCoins(-selectedCharacter.price);
    ownedCharacters.push({
      id: selectedCharacter.id,
      name: selectedCharacter.name,
      model: selectedCharacter.model,
      purchaseDate: new Date().toISOString()
    });
    localStorage.setItem('ownedCharacters', JSON.stringify(ownedCharacters));
    closePurchaseModal();
    showSuccessModal();
    renderCharacters();
  }

  function showSuccessModal() {
    document.getElementById('successMessage').textContent = `¡${selectedCharacter.name} ha sido añadido a "Mis Personajes"!`;
    document.getElementById('successModal').classList.add('show');
  }

  function closeSuccessModal() {
    document.getElementById('successModal').classList.remove('show');
  }

  function selectCharacter(characterId) {
    const character = ownedCharacters.find(char => char.id === characterId);
    if (!character) return;
    localStorage.setItem('selectedCharacter', JSON.stringify(character));
    alert(`✅ ¡${character.name} seleccionado!\n\nAhora será tu compañero en todas las aventuras.`);
  }

  function goToMyCharacters() {
    closeSuccessModal();
    window.location.href = 'mis-personajes.html';
  }

  function goBack() {
    window.location.href = 'intro.html';
  }

  function initScrollIndicator() {
    const indicator = document.getElementById('scrollIndicator');
    window.addEventListener('scroll', () => {
      const scrollTop = window.pageYOffset;
      const docHeight = document.documentElement.scrollHeight - window.innerHeight;
      const scrollPercent = docHeight > 0 ? (scrollTop / docHeight) : 0;
      indicator.style.width = (scrollPercent * 100) + '%';
    });
  }

  function initDragScroll() {
    let isDragging = false;
    let startY = 0;
    let startScrollTop = 0;

    function isInteractiveElement(target) {
      return target.closest('.character-card') || target.closest('.modal-content') || target.closest('button') || target.closest('model-viewer');
    }

    document.addEventListener('mousedown', e => {
      if (isInteractiveElement(e.target)) return;
      isDragging = true;
      startY = e.clientY;
      startScrollTop = window.pageYOffset;
      document.body.classList.add('dragging');
      e.preventDefault();
    });
    document.addEventListener('mousemove', e => {
      if (!isDragging) return;
      const deltaY = startY - e.clientY;
      window.scrollTo(0, startScrollTop + deltaY);
      e.preventDefault();
    });
    document.addEventListener('mouseup', () => {
      isDragging = false;
      document.body.classList.remove('dragging');
    });

    document.addEventListener('touchstart', e => {
      if (isInteractiveElement(e.target)) return;
      isDragging = true;
      startY = e.touches[0].clientY;
      startScrollTop = window.pageYOffset;
    }, { passive: true });
    document.addEventListener('touchmove', e => {
      if (!isDragging) return;
      const deltaY = startY - e.touches[0].clientY;
      window.scrollTo(0, startScrollTop + deltaY);
    }, { passive: true });
    document.addEventListener('touchend', () => {
      isDragging = false;
    });
  }

  function open3DViewer(modelSrc, modelName) {
    if (document.getElementById('viewer3DModal')) return;

    const modal = document.createElement('div');
    modal.id = 'viewer3DModal';
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    modal.setAttribute('aria-label', `Visor 3D ampliado de ${modelName}`);
    modal.style.cssText = `
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 10000;
      cursor: grab;
    `;

    const viewerContainer = document.createElement('div');
    viewerContainer.style.cssText = `
      width: 90vw; max-width: 800px; height: 90vh; border-radius: 25px; overflow: hidden;
      box-shadow: 0 0 40px rgba(255,255,255,0.3);
      background: #222;
      position: relative;
      cursor: grab;
    `;

    const modelViewer = document.createElement('model-viewer');
    modelViewer.src = modelSrc;
    modelViewer.alt = modelName;
    modelViewer.setAttribute('camera-controls', '');
    modelViewer.setAttribute('auto-rotate', '');
    modelViewer.setAttribute('rotation-per-second', '15deg');
    modelViewer.setAttribute('shadow-intensity', '1');
    modelViewer.setAttribute('environment-image', 'neutral');
    modelViewer.setAttribute('exposure', '1');
    modelViewer.setAttribute('loading', 'eager');
    modelViewer.setAttribute('autoplay', '');
    modelViewer.style.width = '100%';
    modelViewer.style.height = '100%';
    modelViewer.style.borderRadius = '25px';

    const closeBtn = document.createElement('button');
    closeBtn.textContent = '✕';
    closeBtn.setAttribute('aria-label', 'Cerrar visor 3D ampliado');
    closeBtn.style.cssText = `
      position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2);
      border: none; color: white; font-size: 2rem; border-radius: 50%;
      width: 40px; height: 40px; cursor: pointer; transition: background 0.3s ease;
      z-index: 10;
    `;
    closeBtn.onmouseenter = () => closeBtn.style.background = 'rgba(255,255,255,0.6)';
    closeBtn.onmouseleave = () => closeBtn.style.background = 'rgba(255,255,255,0.2)';
    closeBtn.onclick = () => {
      document.body.removeChild(modal);
      document.body.style.overflow = '';
    };

    viewerContainer.appendChild(modelViewer);
    viewerContainer.appendChild(closeBtn);
    modal.appendChild(viewerContainer);
    document.body.appendChild(modal);

    document.body.style.overflow = 'hidden';
  }

  window.addEventListener('load', () => {
    loadPlayerCoins();
    loadOwnedCharacters();
    renderCharacters();
    initScrollIndicator();
    initDragScroll();
  });

  window.filterCharacters = filterCharacters;
  window.openPurchaseModal = openPurchaseModal;
  window.closePurchaseModal = closePurchaseModal;
  window.confirmPurchase = confirmPurchase;
  window.closeSuccessModal = closeSuccessModal;
  window.selectCharacter = selectCharacter;
  window.goToMyCharacters = goToMyCharacters;
  window.goBack = goBack;
  window.open3DViewer = open3DViewer;
</script>

</body>
</html>