<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Tienda de Personajes - Compra tu Compañero Ideal</title>
<script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>
<style>
  :root {
    --primary-color: #ff6b6b;
    --secondary-color: #4ecdc4;
    --accent-color: #45b7d1;
    --success-color: #00b894;
    --warning-color: #fdcb6e;
    --error-color: #e17055;
    --purple-color: #a29bfe;
    --orange-color: #fd79a8;
    --coin-color: #f39c12;
    --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --card-gradient: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(240, 248, 255, 0.95));
    --text-light: #ffffff;
    --text-dark: #2d3436;
    --shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
  }
  * {
    margin: 0; padding: 0; box-sizing: border-box;
  }
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
  }
  body {
    font-family: 'Comic Sans MS', cursive, sans-serif;
    background: var(--background-gradient);
    min-height: 100vh;
    overflow-y: auto;
    overflow-x: hidden;
    position: relative;
    scroll-behavior: smooth;
    cursor: grab;
    font-size: 16px;
    color: var(--text-dark);
  }
  body.dragging {
    cursor: grabbing;
    user-select: none;
  }
  @media (min-width: 769px) {
    ::-webkit-scrollbar {
      width: 18px;
    }
    ::-webkit-scrollbar-track {
      background: linear-gradient(180deg, rgba(255, 107, 107, 0.3), rgba(78, 205, 196, 0.3));
      border-radius: 15px;
      border: 2px solid rgba(255, 255, 255, 0.2);
    }
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #ff6b6b, #4ecdc4, #45b7d1, #a29bfe);
      border-radius: 15px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
    }
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #e55656, #3bb8b0, #3a9bc1, #8b7ed8);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
    }
  }
  .scroll-indicator {
    position: fixed;
    top: 0; left: 0;
    width: 0%;
    height: 6px;
    background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #a29bfe, #fd79a8);
    z-index: 1000;
    transition: width 0.3s ease;
    box-shadow: 0 3px 15px rgba(0, 0, 0, 0.4);
  }
  .floating-decoration {
    position: fixed;
    font-size: 2.5rem;
    opacity: 0.7;
    animation: float 6s ease-in-out infinite;
    pointer-events: none;
    z-index: 1;
  }
  .decoration-1 { top: 10%; left: 10%; animation-delay: 0s; }
  .decoration-2 { top: 20%; right: 15%; animation-delay: 1s; }
  .decoration-3 { bottom: 20%; left: 20%; animation-delay: 2s; }
  .decoration-4 { top: 60%; right: 10%; animation-delay: 3s; }
  .decoration-5 { bottom: 10%; right: 25%; animation-delay: 4s; }
  .decoration-6 { top: 40%; left: 5%; animation-delay: 5s; }
  @keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.7; }
    50% { transform: translateY(-25px) rotate(15deg); opacity: 1; }
  }
  .header {
    position: fixed;
    top: 0; left: 0; right: 0;
    background: linear-gradient(135deg, rgba(0,0,0,0.9), rgba(45, 52, 54, 0.9));
    backdrop-filter: blur(15px);
    padding: 1rem 2rem;
    z-index: 100;
    border-bottom: 3px solid rgba(78, 205, 196, 0.3);
    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
  }
  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 1200px;
    margin: 0 auto;
  }
  .header-title {
    color: var(--text-light);
    font-size: 2.2rem;
    font-weight: bold;
    text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
    background: linear-gradient(45deg, #fff, var(--secondary-color));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .header-stats {
    display: flex;
    align-items: center;
    gap: 20px;
  }
  .coin-display {
    background: linear-gradient(45deg, var(--coin-color), #e67e22);
    color: white;
    padding: 12px 24px 12px 12px;
    border-radius: 25px;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 14px;
    font-size: 1.2rem;
    animation: coinGlow 2s infinite;
    border: 3px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
  }
  .coin-display span:first-child {
    font-size: 1.6rem;
  }
  .back-button {
    background: linear-gradient(45deg, var(--primary-color), var(--orange-color));
    color: white;
    padding: 12px 25px;
    font-size: 1rem;
    font-weight: bold;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    border: 2px solid rgba(255, 255, 255, 0.2);
  }
  .back-button:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 10px 25px rgba(255, 107, 107, 0.6);
  }
  .main-content {
    margin-top: 100px;
    padding: 2rem;
    min-height: calc(100vh - 100px);
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
  }
  .main-title {
    text-align: center;
    color: var(--text-light);
    font-size: 3rem;
    font-weight: bold;
    text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.8);
    margin-bottom: 1rem;
    background: linear-gradient(45deg, #fff, var(--secondary-color), var(--accent-color));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: titleGlow 3s infinite;
  }
  .main-subtitle {
    text-align: center;
    color: var(--text-light);
    font-size: 1.4rem;
    opacity: 0.9;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    margin-bottom: 3rem;
  }
  .character-filters {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 3rem;
    flex-wrap: wrap;
  }
  .filter-btn {
    background: linear-gradient(45deg, var(--secondary-color), var(--accent-color));
    color: white;
    padding: 10px 20px;
    font-size: 1rem;
    font-weight: bold;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid rgba(255, 255, 255, 0.3);
  }
  .filter-btn:hover, .filter-btn.active {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 8px 20px rgba(78, 205, 196, 0.6);
  }
  .filter-btn.active {
    background: linear-gradient(45deg, var(--success-color), #55efc4);
  }
  .characters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 30px;
    margin-bottom: 3rem;
  }
  .character-card {
    background: var(--card-gradient);
    border-radius: 25px;
    padding: 1.5rem 1.5rem 2rem 1.5rem;
    box-shadow: var(--shadow);
    border: 3px solid rgba(78, 205, 196, 0.4);
    backdrop-filter: blur(15px);
    position: relative;
    overflow: hidden;
    animation: fadeInUp 1s ease-out both;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .character-card:hover {
    transform: translateY(-15px) scale(1.05);
    box-shadow: 0 30px 70px rgba(0, 0, 0, 0.5);
  }
  .character-card.owned {
    border-color: var(--success-color);
    background: linear-gradient(135deg, rgba(0, 184, 148, 0.1), rgba(255, 255, 255, 0.95));
  }
  .character-card.owned::after {
    content: '✅ COMPRADO';
    position: absolute;
    top: 15px;
    right: 15px;
    background: var(--success-color);
    color: white;
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: bold;
    z-index: 10;
  }
  .character-model {
    width: 100%;
    height: 280px;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    background: radial-gradient(circle, rgba(78, 205, 196, 0.2), rgba(69, 183, 209, 0.2));
    position: relative;
  }
  .character-model model-viewer {
    width: 100%;
    height: 100%;
    border-radius: 20px;
  }
  .expand-btn {
    position: absolute;
    bottom: 10px;
    right: 10px;
    background: var(--accent-color);
    border-radius: 50%;
    width: 36px;
    height: 36px;
    border: none;
    color: white;
    font-size: 24px;
    line-height: 36px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    transition: background 0.3s ease;
    z-index: 20;
  }
  .expand-btn:hover {
    background: var(--secondary-color);
  }
  .character-info {
    text-align: center;
    margin-top: 1rem;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  .character-name {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
    text-transform: capitalize;
  }
  .character-description {
    font-size: 1rem;
    color: #636e72;
    margin-bottom: 1rem;
    line-height: 1.4;
    flex-grow: 1;
  }
  .character-rarity {
    display: inline-block;
    padding: 5px 15px;
    border-radius: 15px;
    font-size: 0.9rem;
    font-weight: bold;
    margin-bottom: 1rem;
  }
  .rarity-comun {
    background: linear-gradient(45deg, #74b9ff, #0984e3);
    color: white;
  }
  .rarity-raro {
    background: linear-gradient(45deg, #a29bfe, #6c5ce7);
    color: white;
  }
  .rarity-epico {
    background: linear-gradient(45deg, #fd79a8, #e84393);
    color: white;
  }
  .rarity-legendario {
    background: linear-gradient(45deg, #fdcb6e, #e17055);
    color: white;
    animation: legendaryGlow 2s infinite;
  }
  @keyframes legendaryGlow {
    0%, 100% { box-shadow: 0 0 10px rgba(253, 203, 110, 0.5); }
    50% { box-shadow: 0 0 20px rgba(253, 203, 110, 0.8); }
  }
  .character-price {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 2px solid rgba(78, 205, 196, 0.3);
  }
  .price-display {
    display: flex;
    align-items: center;
    gap: 14px;
    font-size: 1.3rem;
    font-weight: bold;
    color: var(--coin-color);
  }
  .buy-button {
    background: linear-gradient(45deg, var(--success-color), #55efc4);
    color: white;
    padding: 10px 20px;
    font-size: 1rem;
    font-weight: bold;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid rgba(255, 255, 255, 0.3);
  }
  .buy-button:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 8px 20px rgba(0, 184, 148, 0.6);
  }
  .buy-button:disabled {
    background: linear-gradient(45deg, #636e72, #2d3436);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
  .buy-button.owned {
    background: linear-gradient(45deg, var(--accent-color), #74b9ff);
  }
  .new-characters-card {
    background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
    border-radius: 25px;
    padding: 2rem;
    box-shadow: 0 15px 40px rgba(255, 105, 135, 0.5);
    border: 3px solid rgba(255, 105, 135, 0.7);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    font-weight: bold;
    font-size: 1.5rem;
    color: #fff;
    cursor: default;
    user-select: none;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .new-characters-card:hover {
    transform: scale(1.05);
    box-shadow: 0 25px 60px rgba(255, 105, 135, 0.8);
  }
  .new-characters-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
  }
  /* Modal styles */
  .purchase-modal {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background:rgba(0,0,0,0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .purchase-modal.show {
    opacity: 1;
    pointer-events: auto;
  }
  .modal-content {
    background: var(--card-gradient);
    border-radius: 25px;
    padding: 2rem;
    max-width: 600px;
    width: 90%;
    box-shadow: var(--shadow);
    text-align: center;
    position: relative;
  }
  .modal-character {
    width: 100%;
    height: 300px;
    margin-bottom: 1rem;
  }
  .modal-character model-viewer {
    width: 100%;
    height: 100%;
    border-radius: 20px;
  }
  .modal-title {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
    color: var(--text-dark);
  }
  .modal-message {
    font-size: 1.1rem;
    margin-bottom: 1rem;
    color: #555;
  }
  .modal-price {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--coin-color);
    margin-bottom: 1.5rem;
  }
  .modal-buttons {
    display: flex;
    justify-content: center;
    gap: 20px;
  }
  .modal-btn {
    padding: 12px 30px;
    font-size: 1.1rem;
    font-weight: bold;
    border-radius: 25px;
    border: none;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  .modal-btn.confirm {
    background: var(--success-color);
    color: white;
  }
  .modal-btn.confirm:hover {
    background: #009f7f;
  }
  .modal-btn.cancel {
    background: var(--error-color);
    color: white;
  }
  .modal-btn.cancel:hover {
    background: #c94a3f;
  }
  /* Success modal */
  .success-modal {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background:rgba(0,0,0,0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .success-modal.show {
    opacity: 1;
    pointer-events: auto;
  }
  .success-content {
    background: var(--card-gradient);
    border-radius: 25px;
    padding: 2rem;
    max-width: 500px;
    width: 90%;
    box-shadow: var(--shadow);
    text-align: center;
    position: relative;
  }
  .success-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
  }
  .success-title {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
    color: var(--success-color);
  }
  .success-message {
    font-size: 1.2rem;
    margin-bottom: 1.5rem;
    color: #555;
  }
  .success-buttons {
    display: flex;
    justify-content: center;
    gap: 20px;
  }
  .success-btn {
    padding: 12px 25px;
    font-size: 1.1rem;
    font-weight: bold;
    border-radius: 25px;
    border: none;
    cursor: pointer;
    background: var(--primary-color);
    color: white;
    transition: background 0.3s ease;
  }
  .success-btn:hover {
    background: #e04e4e;
  }
  /* Animations */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  @keyframes coinGlow {
    0%, 100% {
      text-shadow: 0 0 10px #f39c12, 0 0 20px #f39c12;
    }
    50% {
      text-shadow: 0 0 20px #f39c12, 0 0 30px #f39c12;
    }
  }
  @keyframes titleGlow {
    0%, 100% {
      text-shadow: 0 0 10px #4ecdc4, 0 0 20px #4ecdc4;
    }
    50% {
      text-shadow: 0 0 20px #4ecdc4, 0 0 30px #4ecdc4;
    }
  }
</style>
</head>
<body>

  <!-- Scroll indicator -->
  <div class="scroll-indicator" id="indicadorScroll"></div>
  <!-- Floating decorations -->
  <div class="floating-decoration decoration-1">🛒</div>
  <div class="floating-decoration decoration-2">👾</div>
  <div class="floating-decoration decoration-3">💎</div>
  <div class="floating-decoration decoration-4">🎭</div>
  <div class="floating-decoration decoration-5">🌟</div>
  <div class="floating-decoration decoration-6">🎪</div>
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <h1 class="header-title">🛒 Tienda de Personajes</h1>
      <div class="header-stats">
        <div class="coin-display" aria-label="Monedas disponibles">
          <span>🪙</span>
          <span id="monedasJugador">0</span>
          <span>Monedas</span>
        </div>
        <button class="back-button" onclick="volverAlMenu()" aria-label="Volver al menú principal">🔙 Volver al Menú</button>
      </div>
    </div>
  </div>
  <!-- Main content -->
  <main class="main-content">
    <h1 class="main-title">🎭 Elige tu Compañero Perfecto</h1>
    <p class="main-subtitle">¡Descubre increíbles personajes 3D para acompañarte en tu aventura de aprendizaje!</p>
    <!-- Filters -->
    <div class="character-filters" role="group" aria-label="Filtros de personajes">
      <button class="filter-btn active" data-filter="todos" aria-pressed="true">🌟 Todos</button>
      <button class="filter-btn" data-filter="comun" aria-pressed="false">🔵 Común</button>
      <button class="filter-btn" data-filter="raro" aria-pressed="false">🟣 Raro</button>
      <button class="filter-btn" data-filter="epico" aria-pressed="false">🟡 Épico</button>
      <button class="filter-btn" data-filter="legendario" aria-pressed="false">🔥 Legendario</button>
      <button class="filter-btn" data-filter="comprados" aria-pressed="false">✅ Comprados</button>
    </div>
    <!-- Characters grid -->
    <div class="characters-grid" id="rejillaPersonajes" role="list"></div>
  </main>

  <!-- Modal de compra -->
  <div class="purchase-modal" id="modalCompra" role="dialog" aria-modal="true" aria-labelledby="tituloModal" aria-describedby="mensajeModal" tabindex="-1">
    <div class="modal-content">
      <div class="modal-character" id="personajeModal">
        <model-viewer 
          id="modeloPersonajeModal"
          src=""
          alt="Personaje 3D"
          camera-controls
          auto-rotate
          rotation-per-second="20deg"
          shadow-intensity="1"
          environment-image="neutral"
          exposure="1"
          loading="eager"
          autoplay
        ></model-viewer>
      </div>
      <h2 class="modal-title" id="tituloModal">¿Comprar Personaje?</h2>
      <p class="modal-message" id="mensajeModal">¿Estás seguro de que quieres comprar este increíble personaje?</p>
      <div class="modal-price" id="precioModal">🪙 50 Monedas</div>
      <div class="modal-buttons">
        <button class="modal-btn confirm" id="btnConfirmarCompra" aria-label="Confirmar compra">✅ Comprar</button>
        <button class="modal-btn cancel" id="btnCancelarCompra" aria-label="Cancelar compra">❌ Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal de éxito -->
  <div class="success-modal" id="modalExito" role="alertdialog" aria-modal="true" aria-labelledby="tituloExito" aria-describedby="mensajeExito" tabindex="-1">
    <div class="success-content">
      <div class="success-icon" aria-hidden="true">🎉</div>
      <h2 class="success-title" id="tituloExito">¡Compra Exitosa!</h2>
      <p class="success-message" id="mensajeExito">Tu nuevo personaje ha sido añadido a "Mis Personajes"</p>
      <div class="success-buttons">
        <button class="success-btn" id="btnVerMisPersonajes" aria-label="Ver mis personajes">👥 Ver Mis Personajes</button>
        <button class="success-btn" id="btnSeguirComprando" aria-label="Seguir comprando">🛒 Seguir Comprando</button>
      </div>
    </div>
  </div>

<script>
  // URL base del backend (ajusta según tu servidor)
  const URL_BACKEND = 'http://localhost:3000';

  let monedasJugador = 0;
  let personajesComprados = [];
  let filtroActual = 'todos';
  let personajeSeleccionado = null;
  const esMovil = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

  // Obtener monedas y personajes comprados del backend
  async function cargarDatosJugador() {
    try {
      const resMonedas = await fetch(`${URL_BACKEND}/monedas`, {headers: { 'authorization': localStorage.getItem("token") }   });
      if (!resMonedas.ok) throw new Error('Error al obtener monedas');
      const dataMonedas = await resMonedas.json();
      monedasJugador = dataMonedas.monedas || 0;
      document.getElementById('monedasJugador').textContent = monedasJugador;

      const resComprados = await fetch(`${URL_BACKEND}/api/personajes`, { 'authorization': localStorage.getItem("token")});
      if (!resComprados.ok) throw new Error('Error al obtener personajes comprados');
      personajesComprados = await resComprados.json();

      await cargarPersonajesDisponibles();
    } catch (error) {
      alert('Error al cargar datos del jugador: ' + error.message);
    }
  }

  // Obtener personajes disponibles del backend
  let personajesDisponibles = [];
  async function cargarPersonajesDisponibles() {
    try {
      const res = await fetch(`${URL_BACKEND}/api/personajes`, { credentials: 'include' });
      if (!res.ok) throw new Error('Error al obtener personajes');
      personajesDisponibles = await res.json();
      renderizarPersonajes();
    } catch (error) {
      alert('Error al cargar personajes: ' + error.message);
    }
  }

  // Traducción rareza
  function textoRareza(rareza) {
    const textos = {
      comun: '🔵 Común',
      raro: '🟣 Raro',
      epico: '🟡 Épico',
      legendario: '🔥 Legendario'
    };
    return textos[rareza] || rareza;
  }

  // Renderizar personajes en la grilla
  function renderizarPersonajes() {
    const rejilla = document.getElementById('rejillaPersonajes');
    rejilla.innerHTML = '';

    // Tarjeta de nuevos personajes
    const nuevaTarjeta = document.createElement('div');
    nuevaTarjeta.className = 'new-characters-card';
    nuevaTarjeta.setAttribute('role', 'listitem');
    nuevaTarjeta.setAttribute('tabindex', '0');
    nuevaTarjeta.innerHTML = `
      <div class="new-characters-icon" aria-hidden="true">✨</div>
      ¡Próximamente nuevos personajes increíbles!
      <br><small>¡Mantente atento para más sorpresas!</small>
    `;
    rejilla.appendChild(nuevaTarjeta);

    let filtrados = personajesDisponibles;
    if (filtroActual !== 'todos') {
      if (filtroActual === 'comprados') {
        filtrados = personajesDisponibles.filter(p => personajesComprados.some(pc => pc.id === p.id));
      } else {
        filtrados = personajesDisponibles.filter(p => p.rareza === filtroActual);
      }
    }

    if (filtrados.length === 0) {
      const sinResultados = document.createElement('div');
      sinResultados.style.gridColumn = '1 / -1';
      sinResultados.style.textAlign = 'center';
      sinResultados.style.padding = '3rem';
      sinResultados.style.color = 'white';
      sinResultados.style.fontSize = '1.5rem';
      sinResultados.setAttribute('role', 'listitem');
      sinResultados.innerHTML = `
        <div style="font-size: 4rem; margin-bottom: 1rem;">😔</div>
        No se encontraron personajes con este filtro
      `;
      rejilla.appendChild(sinResultados);
      return;
    }

    filtrados.forEach((personaje, i) => {
      const comprado = personajesComprados.some(pc => pc.id === personaje.id);
      const puedeComprar = monedasJugador >= personaje.precio;

      const tarjeta = document.createElement('div');
      tarjeta.className = `character-card ${comprado ? 'owned' : ''}`;
      tarjeta.style.animationDelay = `${i * 0.1}s`;
      tarjeta.setAttribute('role', 'listitem');
      tarjeta.setAttribute('tabindex', '0');

      tarjeta.innerHTML = `
        <div class="character-model" tabindex="0" aria-label="Modelo 3D de ${personaje.nombre}">
          <model-viewer 
            src="${personaje.modelo}"
            alt="${personaje.nombre}"
            camera-controls
            auto-rotate
            rotation-per-second="${esMovil ? '10deg' : '15deg'}"
            shadow-intensity="1"
            environment-image="neutral"
            exposure="1"
            loading="eager"
            interaction-prompt="${esMovil ? 'none' : 'auto'}"
          ></model-viewer>
          <button class="expand-btn" aria-label="Ampliar modelo 3D de ${personaje.nombre}" onclick="abrirVisor3D('${personaje.modelo}', '${personaje.nombre}')">🔍</button>
        </div>
        <div class="character-info">
          <h3 class="character-name">${personaje.nombre}</h3>
          <p class="character-description">${personaje.descripcion}</p>
          <span class="character-rarity rarity-${personaje.rareza}">${textoRareza(personaje.rareza)}</span>
          <div class="character-price">
            <div class="price-display" aria-label="Precio: ${personaje.precio} monedas">
              🪙 ${personaje.precio}
            </div>
            <button 
              class="buy-button ${comprado ? 'owned' : ''}" 
              ${comprado ? 'disabled aria-disabled="true"' : (!puedeComprar ? 'disabled aria-disabled="true"' : '')}
              aria-label="${comprado ? 'Personaje comprado' : puedeComprar ? 'Comprar personaje' : 'No tienes suficientes monedas para comprar este personaje'}"
              onclick="abrirModalCompra(${personaje.id})"
            >
              ${comprado ? 'Comprado' : 'Comprar'}
            </button>
          </div>
        </div>
      `;
      rejilla.appendChild(tarjeta);
    });
  }

  // Cambiar filtro
  function cambiarFiltro(e) {
    const btn = e.target;
    if (!btn.classList.contains('filter-btn')) return;

    document.querySelectorAll('.filter-btn').forEach(b => {
      b.classList.remove('active');
      b.setAttribute('aria-pressed', 'false');
    });
    btn.classList.add('active');
    btn.setAttribute('aria-pressed', 'true');

    filtroActual = btn.getAttribute('data-filter');
    renderizarPersonajes();
  }

  // Abrir modal compra
  function abrirModalCompra(idPersonaje) {
    personajeSeleccionado = personajesDisponibles.find(p => p.id === idPersonaje);
    if (!personajeSeleccionado) return;

    const modal = document.getElementById('modalCompra');
    const modeloModal = document.getElementById('modeloPersonajeModal');
    const tituloModal = document.getElementById('tituloModal');
    const mensajeModal = document.getElementById('mensajeModal');
    const precioModal = document.getElementById('precioModal');
    const btnConfirmar = document.getElementById('btnConfirmarCompra');

    modeloModal.src = personajeSeleccionado.modelo;
    modeloModal.alt = personajeSeleccionado.nombre;
    tituloModal.textContent = `Comprar "${personajeSeleccionado.nombre}"`;
    mensajeModal.textContent = personajeSeleccionado.descripcion;
    precioModal.textContent = `🪙 ${personajeSeleccionado.precio} Monedas`;

    btnConfirmar.disabled = monedasJugador < personajeSeleccionado.precio;
    btnConfirmar.setAttribute('aria-disabled', btnConfirmar.disabled ? 'true' : 'false');

    modal.classList.add('show');
    modal.focus();
  }

  // Cerrar modal compra
  function cerrarModalCompra() {
    const modal = document.getElementById('modalCompra');
    modal.classList.remove('show');
    personajeSeleccionado = null;
  }

  // Confirmar compra (envía al backend)
  async function confirmarCompra() {
    if (!personajeSeleccionado) return;

    if (monedasJugador < personajeSeleccionado.precio) {
      alert('No tienes suficientes monedas para comprar este personaje.');
      return;
    }

    try {
      const res = await fetch(`${URL_BACKEND}/personajes/comprar`, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ idPersonaje: personajeSeleccionado.id })
      });
      if (!res.ok) {
        const errorData= await res.json();
        throw new Error(errorData.mensaje || 'Error al procesar la compra');
      }
      const data = await res.json();
      // Actualizar monedas y personajes comprados localmente
      monedasJugador = data.monedasActualizadas;
      personajesComprados = data.personajesComprados;
      document.getElementById('monedasJugador').textContent = monedasJugador;
      cerrarModalCompra();
      mostrarModalExito();
      renderizarPersonajes();
    } catch (error) {
      alert('Error en la compra: ' + error.message);
    }
  }

  // Mostrar modal éxito
  function mostrarModalExito() {
    const modalExito = document.getElementById('modalExito');
    const mensajeExito = document.getElementById('mensajeExito');
    mensajeExito.textContent = `¡${personajeSeleccionado.nombre} ha sido añadido a "Mis Personajes"!`;
    modalExito.classList.add('show');
    modalExito.focus();
  }

  // Cerrar modal éxito
  function cerrarModalExito() {
    const modalExito = document.getElementById('modalExito');
    modalExito.classList.remove('show');
  }

  // Ver mis personajes (redirigir)
  function verMisPersonajes() {
    cerrarModalExito();
    window.location.href = 'mis-personajes.html';
  }

  // Seguir comprando
  function seguirComprando() {
    cerrarModalExito();
  }

  // Volver al menú principal
  function volverAlMenu() {
    window.location.href = 'intro.html';
  }

  // Indicador de scroll
  function inicializarIndicadorScroll() {
    const indicador = document.getElementById('indicadorScroll');
    window.addEventListener('scroll', () => {
      const scrollTop = window.pageYOffset;
      const docHeight = document.documentElement.scrollHeight - window.innerHeight;
      const scrollPercent = docHeight > 0 ? (scrollTop / docHeight) : 0;
      indicador.style.width = (scrollPercent * 100) + '%';
    });
  }

  // Scroll con arrastre
  function inicializarScrollArrastre() {
    let arrastrando = false;
    let inicioY = 0;
    let inicioScrollTop = 0;

    function esElementoInteractivo(target) {
      return target.closest('.character-card') || target.closest('.modal-content') || target.closest('button') || target.closest('model-viewer');
    }

    document.addEventListener('mousedown', e => {
      if (esElementoInteractivo(e.target)) return;
      arrastrando = true;
      inicioY = e.clientY;
      inicioScrollTop = window.pageYOffset;
      document.body.classList.add('dragging');
      e.preventDefault();
    });
    document.addEventListener('mousemove', e => {
      if (!arrastrando) return;
      const deltaY = inicioY - e.clientY;
      window.scrollTo(0, inicioScrollTop + deltaY);
      e.preventDefault();
    });
    document.addEventListener('mouseup', () => {
      arrastrando = false;
      document.body.classList.remove('dragging');
    });

    document.addEventListener('touchstart', e => {
      if (esElementoInteractivo(e.target)) return;
      arrastrando = true;
      inicioY = e.touches[0].clientY;
      inicioScrollTop = window.pageYOffset;
    }, { passive: true });
    document.addEventListener('touchmove', e => {
      if (!arrastrando) return;
      const deltaY = inicioY - e.touches[0].clientY;
      window.scrollTo(0, inicioScrollTop + deltaY);
    }, { passive: true });
    document.addEventListener('touchend', () => {
      arrastrando = false;
    });
  }

  // Abrir visor 3D ampliado
  function abrirVisor3D(modeloSrc, nombreModelo) {
    if (document.getElementById('visor3DModal')) return;

    const modal = document.createElement('div');
    modal.id = 'visor3DModal';
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    modal.setAttribute('aria-label', `Visor 3D ampliado de ${nombreModelo}`);
    modal.style.cssText = `
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.9);
      display: flex; justify-content: center; align-items: center;
      z-index: 10000;
      cursor: grab;
    `;

    const contenedor = document.createElement('div');
    contenedor.style.cssText = `
      width: 90vw; max-width: 800px; height: 90vh; border-radius: 25px; overflow: hidden;
      box-shadow: 0 0 40px rgba(255,255,255,0.3);
      background: #222;
      position: relative;
      cursor: grab;
    `;

    const modelViewer = document.createElement('model-viewer');
    modelViewer.src = modeloSrc;
    modelViewer.alt = nombreModelo;
    modelViewer.setAttribute('camera-controls', '');
    modelViewer.setAttribute('auto-rotate', '');
    modelViewer.setAttribute('rotation-per-second', '15deg');
    modelViewer.setAttribute('shadow-intensity', '1');
    modelViewer.setAttribute('environment-image', 'neutral');
    modelViewer.setAttribute('exposure', '1');
    modelViewer.setAttribute('loading', 'eager');
    modelViewer.setAttribute('autoplay', '');
    modelViewer.style.width = '100%';
    modelViewer.style.height = '100%';
    modelViewer.style.borderRadius = '25px';

    const btnCerrar = document.createElement('button');
    btnCerrar.textContent = '✕';
    btnCerrar.setAttribute('aria-label', 'Cerrar visor 3D ampliado');
    btnCerrar.style.cssText = `
      position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2);
      border: none; color: white; font-size: 2rem; border-radius: 50%;
      width: 40px; height: 40px; cursor: pointer; transition: background 0.3s ease;
      z-index: 10;
    `;
    btnCerrar.onmouseenter = () => btnCerrar.style.background = 'rgba(255,255,255,0.6)';
    btnCerrar.onmouseleave = () => btnCerrar.style.background = 'rgba(255,255,255,0.2)';
    btnCerrar.onclick = () => {
      document.body.removeChild(modal);
      document.body.style.overflow = '';
    };

    contenedor.appendChild(modelViewer);
    contenedor.appendChild(btnCerrar);
    modal.appendChild(contenedor);
    document.body.appendChild(modal);

    document.body.style.overflow = 'hidden';
  }

  // Inicialización al cargar la página
  window.addEventListener('load', () => {
    cargarDatosJugador();
    inicializarIndicadorScroll();
    inicializarScrollArrastre();
  });

  // Asignar funciones globales para uso en HTML
  window.cambiarFiltro = cambiarFiltro;
  window.abrirModalCompra = abrirModalCompra;
  window.cerrarModalCompra = cerrarModalCompra;
  window.confirmarCompra = confirmarCompra;
  window.cerrarModalExito = cerrarModalExito;
  window.verMisPersonajes = verMisPersonajes;
  window.seguirComprando = seguirComprando;
  window.volverAlMenu = volverAlMenu;
  window.abrirVisor3D = abrirVisor3D;

  // Asignar eventos a botones del modal para accesibilidad y evitar inline JS
  document.getElementById('btnConfirmarCompra').addEventListener('click', confirmarCompra);
  document.getElementById('btnCancelarCompra').addEventListener('click', cerrarModalCompra);
  document.getElementById('btnVerMisPersonajes').addEventListener('click', verMisPersonajes);
  document.getElementById('btnSeguirComprando').addEventListener('click', seguirComprando);

  // Asignar eventos a botones de filtro
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', cambiarFiltro);
  });
</script>

</body>
</html>