<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Restablecer ContraseÃ±a - Mundo de Aprendizaje</title>
  <style>
    :root {
      --primary-color: #ff6b6b;
      --secondary-color: #4ecdc4;
      --accent-color: #45b7d1;
      --warning-color: #f9ca24;
      --success-color: #6c5ce7;
      --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --card-background: rgba(255, 255, 255, 0.95);
      --text-dark: #2c3e50;
      --text-light: #ffffff;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Comic Sans MS', cursive, sans-serif;
      background: var(--background-gradient);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow-x: hidden;
      position: relative;
      cursor: none; /* Oculta cursor nativo */
    }
    /* Cursor personalizado: pequeÃ±o punto */
    #custom-cursor {
      position: fixed;
      top: 0;
      left: 0;
      width: 10px;
      height: 10px;
      background: white;
      border-radius: 50%;
      pointer-events: none;
      transform: translate(-50%, -50%);
      z-index: 10000;
      box-shadow: 0 0 8px 2px rgba(78, 205, 196, 0.8);
      transition: background 0.2s ease;
    }
    /* Chispas con borde suave y sombra para buena visibilidad sin ser toscas */
    .sparkle {
      position: fixed;
      pointer-events: none;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      opacity: 1;
      z-index: 9999;
      mix-blend-mode: normal;
      animation: sparkle-move 0.8s forwards;
      border: 1.2px solid rgba(255 255 255 / 0.85);
      box-shadow:
        0 0 6px 2px rgba(255 255 255 / 0.85),
        0 0 8px 4px currentColor;
      background-clip: padding-box;
    }
    .sparkle.color-1 { background: radial-gradient(circle, #7fd8f7 0%, #4ecdc4 70%, transparent 90%); color: #4ecdc4; }
    .sparkle.color-2 { background: radial-gradient(circle, #a0e9d8 0%, #38b2ac 70%, transparent 90%); color: #38b2ac; }
    .sparkle.color-3 { background: radial-gradient(circle, #8ecae6 0%, #219ebc 70%, transparent 90%); color: #219ebc; }
    .sparkle.color-4 { background: radial-gradient(circle, #b2f7ef 0%, #2d6a4f 70%, transparent 90%); color: #2d6a4f; }
    .sparkle.color-5 { background: radial-gradient(circle, #9be7d1 0%, #40916c 70%, transparent 90%); color: #40916c; }

    @keyframes sparkle-move {
      0% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
      100% {
        transform: translateY(-15px) scale(0.3);
        opacity: 0;
      }
    }

    /* Decoraciones flotantes */
    .floating-decoration {
      position: fixed;
      font-size: 2rem;
      opacity: 0.6;
      animation: float 6s ease-in-out infinite;
      pointer-events: none;
      z-index: 1;
    }
    .decoration-1 { top: 10%; left: 10%; animation-delay: 0s; }
    .decoration-2 { top: 20%; right: 15%; animation-delay: 1s; }
    .decoration-3 { bottom: 20%; left: 20%; animation-delay: 2s; }
    .decoration-4 { top: 60%; right: 10%; animation-delay: 3s; }
    .decoration-5 { bottom: 10%; right: 25%; animation-delay: 4s; }
    .decoration-6 { top: 40%; left: 5%; animation-delay: 5s; }
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(10deg); }
    }

    /* Contenedor principal */
    .reset-container {
      background: var(--card-background);
      border-radius: 25px;
      padding: 3rem 2.5rem;
      box-shadow: var(--shadow);
      text-align: center;
      max-width: 450px;
      width: 90%;
      position: relative;
      z-index: 10;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      animation: fadeInUp 1s ease-out forwards;
    }

    h1 {
      color: var(--text-dark);
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }

    p.subtitle {
      color: var(--text-dark);
      font-size: 1.2rem;
      margin-bottom: 2rem;
      opacity: 0.8;
    }

    form {
      text-align: left;
    }

    .input-group {
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-dark);
      font-weight: bold;
      font-size: 1rem;
    }

    input[type="password"] {
      width: 100%;
      padding: 1rem;
      border: 2px solid rgba(0, 0, 0, 0.1);
      border-radius: 15px;
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.8);
      color: var(--text-dark);
    }

    input[type="password"]:focus {
      outline: none;
      border-color: var(--accent-color);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(69, 183, 209, 0.3);
    }

    button {
      width: 100%;
      padding: 1.2rem 2rem;
      font-size: 1.3rem;
      font-weight: bold;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
      background: linear-gradient(45deg, var(--accent-color), var(--secondary-color));
      color: var(--text-light);
      margin-top: 1rem;
      position: relative;
      overflow: hidden;
    }

    button:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(69, 183, 209, 0.4);
    }

    button:disabled {
      background: #a0cfdc;
      cursor: not-allowed;
      box-shadow: none;
      color: #666;
    }

    .message {
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      font-weight: bold;
      display: none;
      text-align: center;
    }

    .message.error {
      background: rgba(255, 107, 107, 0.2);
      color: #e74c3c;
      border: 2px solid rgba(231, 76, 60, 0.3);
      display: block;
    }

    .message.success {
      background: rgba(46, 204, 113, 0.2);
      color: #27ae60;
      border: 2px solid rgba(39, 174, 96, 0.3);
      display: block;
    }

    small#passwordStrength {
      display: block;
      margin-top: 0.3rem;
      font-weight: bold;
      font-size: 0.9rem;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Caricatura container (opcional) */
    .caricatura-container {
      width: 120px;
      height: 120px;
      margin: 0 auto 2rem auto;
      position: relative;
      animation: fadeInUp 1s ease-out 0.4s both;
    }
    .caricatura-svg {
      width: 100%;
      height: 100%;
      transition: transform 0.3s ease;
      user-select: none;
      pointer-events: none;
      filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.2));
    }
  </style>
</head>
<body>
  <!-- Cursor personalizado -->
  <div id="custom-cursor"></div>

  <!-- Decoraciones flotantes -->
  <div class="floating-decoration decoration-1">ðŸŒŸ</div>
  <div class="floating-decoration decoration-2">ðŸ“š</div>
  <div class="floating-decoration decoration-3">ðŸŽ¨</div>
  <div class="floating-decoration decoration-4">ðŸŽµ</div>
  <div class="floating-decoration decoration-5">ðŸš€</div>
  <div class="floating-decoration decoration-6">âœ¨</div>

  <div class="reset-container" role="main" aria-labelledby="title">
    <h1 id="title">Restablecer ContraseÃ±a</h1>

    <!-- Caricatura animada SVG (opcional) -->
    <div class="caricatura-container" aria-hidden="true">
      <svg class="caricatura-svg" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" >
        <circle cx="100" cy="100" r="80" fill="#FFD93D" stroke="#FFA500" stroke-width="3"/>
        <circle cx="70" cy="110" r="12" fill="#FFB6C1" opacity="0.6"/>
        <circle cx="130" cy="110" r="12" fill="#FFB6C1" opacity="0.6"/>
        <g id="eyes-open" class="eyes-open">
          <ellipse cx="80" cy="85" rx="12" ry="15" fill="white"/>
          <ellipse cx="120" cy="85" rx="12" ry="15" fill="white"/>
          <circle id="pupil-left" cx="80" cy="85" r="6" fill="#333"/>
          <circle id="pupil-right" cx="120" cy="85" r="6" fill="#333"/>
          <circle cx="82" cy="82" r="2" fill="white"/>
          <circle cx="122" cy="82" r="2" fill="white"/>
        </g>
        <g id="eyes-closed" style="display: none;">
          <path d="M 68 85 Q 80 80 92 85" stroke="#333" stroke-width="3" fill="none" stroke-linecap="round"/>
          <path d="M 108 85 Q 120 80 132 85" stroke="#333" stroke-width="3" fill="none" stroke-linecap="round"/>
        </g>
        <path d="M 68 70 Q 80 65 92 70" stroke="#8B4513" stroke-width="4" fill="none" stroke-linecap="round"/>
        <path d="M 108 70 Q 120 65 132 70" stroke="#8B4513" stroke-width="4" fill="none" stroke-linecap="round"/>
        <ellipse cx="100" cy="100" rx="4" ry="6" fill="#FFB347"/>
        <path id="mouth" d="M 80 125 Q 100 140 120 125" stroke="#333" stroke-width="4" fill="none" stroke-linecap="round"/>
        <path d="M 40 80 Q 50 30 100 35 Q 150 30 160 80" fill="#8B4513"/>
        <circle cx="60" cy="50" r="8" fill="#8B4513"/>
        <circle cx="100" cy="45" r="10" fill="#8B4513"/>
        <circle cx="140" cy="50" r="8" fill="#8B4513"/>
      </svg>
    </div>

    <form id="resetForm" novalidate>
      <div class="input-group">
        <label for="password">Nueva contraseÃ±a</label>
        <input type="password" id="password" name="password" required minlength="6" autocomplete="new-password" placeholder="MÃ­nimo 6 caracteres, mayÃºsculas, nÃºmeros y sÃ­mbolos" />
        <small id="passwordStrength" aria-live="polite"></small>
      </div>
      <div class="input-group">
        <label for="confirmPassword">Confirmar contraseÃ±a</label>
        <input type="password" id="confirmPassword" name="confirmPassword" required minlength="6" autocomplete="new-password" placeholder="Repite la contraseÃ±a" />
      </div>
      <button type="submit" id="submitBtn">Actualizar contraseÃ±a</button>
    </form>

    <div id="message" class="message" role="alert" aria-live="polite"></div>
  </div>

  <script>
    // Cursor personalizado y chispas multicolores (igual que en index.html)
    const cursor = document.getElementById('custom-cursor');
    const sparkleColors = ['color-1', 'color-2', 'color-3', 'color-4', 'color-5'];

    document.addEventListener('mousemove', e => {
      cursor.style.left = e.clientX + 'px';
      cursor.style.top = e.clientY + 'px';
      createSparkle(e.clientX, e.clientY);
    });

    function createSparkle(x, y) {
      const sparkle = document.createElement('div');
      sparkle.classList.add('sparkle');
      const colorClass = sparkleColors[Math.floor(Math.random() * sparkleColors.length)];
      sparkle.classList.add(colorClass);
      sparkle.style.left = (x + (Math.random() * 10 - 5)) + 'px';
      sparkle.style.top = (y + (Math.random() * 10 - 5)) + 'px';
      document.body.appendChild(sparkle);
      sparkle.addEventListener('animationend', () => {
        sparkle.remove();
      });
    }

    // Caricatura cierra ojos al escribir contraseÃ±a
    function setCaricaturaListeners(inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;
      input.addEventListener('focus', function() {
        document.getElementById('eyes-open').style.display = 'none';
        document.getElementById('eyes-closed').style.display = 'inline';
      });
      input.addEventListener('blur', function() {
        document.getElementById('eyes-open').style.display = 'inline';
        document.getElementById('eyes-closed').style.display = 'none';
      });
    }
    setCaricaturaListeners('password');
    setCaricaturaListeners('confirmPassword');

    // Obtener token JWT de la URL
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    const token = getQueryParam('token');
    const form = document.getElementById('resetForm');
    const messageDiv = document.getElementById('message');
    const submitBtn = document.getElementById('submitBtn');
    const passwordInput = document.getElementById('password');
    const passwordStrengthText = document.getElementById('passwordStrength');

    if (!token) {
      messageDiv.textContent = 'Token no proporcionado en la URL.';
      messageDiv.classList.add('error');
      submitBtn.disabled = true;
    }

    // FunciÃ³n para validar fuerza de contraseÃ±a
    function isStrongPassword(password) {
      // Al menos 6 caracteres, una mayÃºscula, una minÃºscula, un nÃºmero y un sÃ­mbolo
      const strongRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{6,}$/;
      return strongRegex.test(password);
    }

    // Feedback en tiempo real de fuerza de contraseÃ±a
    passwordInput.addEventListener('input', () => {
      const val = passwordInput.value;
      if (val.length === 0) {
        passwordStrengthText.textContent = '';
        return;
      }
      if (isStrongPassword(val)) {
        passwordStrengthText.textContent = 'ContraseÃ±a fuerte';
        passwordStrengthText.style.color = '#2ecc71';
      } else {
        passwordStrengthText.textContent = 'Debe incluir mayÃºsculas, minÃºsculas, nÃºmeros y sÃ­mbolos';
        passwordStrengthText.style.color = '#e74c3c';
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      messageDiv.textContent = '';
            messageDiv.className = 'message';

      const password = form.password.value.trim();
      const confirmPassword = form.confirmPassword.value.trim();

      if (password.length < 6) {
        messageDiv.textContent = 'La contraseÃ±a debe tener al menos 6 caracteres.';
        messageDiv.classList.add('error');
        return;
      }

      if (!isStrongPassword(password)) {
        messageDiv.textContent = 'La contraseÃ±a debe incluir mayÃºsculas, minÃºsculas, nÃºmeros y sÃ­mbolos.';
        messageDiv.classList.add('error');
        return;
      }

      if (password !== confirmPassword) {
        messageDiv.textContent = 'Las contraseÃ±as no coinciden.';
        messageDiv.classList.add('error');
        return;
      }

      submitBtn.disabled = true;

      try {
        const response = await fetch('http://localhost:3000/reset-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            token: token,
            newPassword: password,
          }),
        });

        const data = await response.json();

        if (response.ok) {
          messageDiv.textContent = data.message || 'ContraseÃ±a actualizada correctamente.';
          messageDiv.classList.remove('error');
          messageDiv.classList.add('success');
          form.reset();
          passwordStrengthText.textContent = '';
          // Opcional: redirigir despuÃ©s de 3 segundos
          // setTimeout(() => window.location.href = 'index.html', 3000);
        } else {
          messageDiv.textContent = data.error || 'Error al actualizar la contraseÃ±a.';
          messageDiv.classList.remove('success');
          messageDiv.classList.add('error');
          submitBtn.disabled = false;
        }
      } catch (error) {
        messageDiv.textContent = 'Error de conexiÃ³n con el servidor.';
        messageDiv.classList.remove('success');
        messageDiv.classList.add('error');
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>